<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>OS | DevOpsエンジニアの備忘録</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>

  <div class="site-container">

    <!-- Header -->
    <header class="site-header">
      <h1>Bash - Pipe Issue</h1>
      <p class="tagline">
        Last Updated: 2026-02-07
      </p>
    </header>

    <!-- Navigation Tabs -->
    <nav class="tabs">
      <a href="/index.html">HOME</a>
      <a href="/cloud/cloud-index.html">Cloud</a>
      <a href="/k8s/k8s-index.html" >Kubernetes</a>
      <a href="/auto/auto-index.html">Automation</a>
      <a href="/os/os-index.html" class="active">OS(Linux/Windows etc.)</a>
      <a href="/db/db-index.html">DB</a>
      <a href="/network/network-index.html">Networking</a>
      <a href="/misc/misc-index.html">Misc</a>
      <a href="/about.html">About Me</a>
    </nav>
    <!-- Article Content -->
    <main class="content">
      <article class="info-card">

        <p>BashのPipe(|)で置きがちな問題とその解決策について</p>
        <br>
        <h2>1. | を使うと発生しうる問題</h2>
        <p>まずは実際の動作をお見せ致します。</p>
        <pre><code>#サンプルテキストファイルに対して、Whileループを回します。
$ cat test.sh 
#!/bin/bash
count=1
cat sample.txt |while read line;do
	echo $count $line
	((count++))
done
echo this is the final count: $count </code></pre>
        <p>こちらがループ対象のテキストファイル</p>
        <code><pre>#サンプルテキストファイル
$ cat sample.txt 
line1
line2
line3</code></pre>
        <p>実行するとどうなるでしょうか？</p>
        <pre><code>$ ./test.sh
1 line1
2 line2
3 line3
this is the final count: 1</code></pre>
        <p>Whileループを回している間はよさそうですね!!・・・ただし、最後<code>this is the final count: 1</code>countが1に戻っています。これがpipeの問題です。whileがsubshellで実行されているため、変数の更新が全て消えてしまいます。</p>
        <br>

        <h2>2. 対応策</h2>
        <h3>2-1. その1</h3>
        <p>問題はWhileループがsubshellで実行されていることですので、whileをcurrent shellで実行してやれば問題解決ということになります。まずは<code>プロセス置換</code>が使った方法をご紹介します。</p>
        <pre><code>$ cat test.sh 
#!/bin/bash
count=1
while read line;do
	echo $count $line
	((count++))
done < <(cat sample.txt)
echo this is the final count: $count</code></pre>
        <h3>2-2. その2</h3>
        <p>プロセス置換を記録として残したくてその1を書きましたが、正直テキストファイルをインプットとして与えるだけであればこちらのほうがきれいですね。</p>
        <pre><code>$ cat test.sh 
#!/bin/bash
count=1
while read line;do
	echo $count $line
	((count++))
done < sample.txt
echo this is the final count: $count</code></pre>
        <p>どちらも実行すると以下のようになります。最終的な値が行数と一致してない気持ち悪さは置いといて変数がちゃんと更新されてますね。</p>
        <pre><code>$ ./test.sh
1 line1
2 line2
3 line3
this is the final count: 4</code></pre>
      </article>
    </main>

    <footer class="site-footer">
      <p>© 2026 takatora</p>
    </footer>
  </div>
</body>
</html>
