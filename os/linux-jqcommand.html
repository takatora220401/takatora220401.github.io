<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>OS | DevOpsエンジニアの備忘録</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>

  <div class="site-container">

    <!-- Header -->
    <header class="site-header">
      <h1>Bash - jqコマンド</h1>
      <p class="tagline">
        Last Updated: 2026-02-10
      </p>
    </header>

    <!-- Navigation Tabs -->
    <nav class="tabs">
      <a href="/index.html">HOME</a>
      <a href="/cloud/cloud-index.html">Cloud</a>
      <a href="/k8s/k8s-index.html" >Kubernetes</a>
      <a href="/auto/auto-index.html">Automation</a>
      <a href="/os/os-index.html" class="active">OS(Linux/Windows etc.)</a>
      <a href="/db/db-index.html">DB</a>
      <a href="/network/network-index.html">Networking</a>
      <a href="/misc/misc-index.html">Misc</a>
      <a href="/about.html">About Me</a>
    </nav>
    <!-- Article Content -->
    <main class="content">
      <article class="info-card">

        <p>jqコマンドについて</p>
        <br>
        <h2>1. モチベーション&勉強方法</h2>
        <p>新卒で入った会社でNSXというネットワーク仮想化製品が送信するSNMP Ttrapの一覧を取得するのにjqコマンドを使っているマニュアルがあったんですね。意味がわからずとも使えてはいたのですが、ちゃんと理解したいと思っていたのでこれを機に学びます。というのは、私の個人的なモチベなわけですが一般的にjqコマンドを知っておくと良い理由はこんな感じでしょうか。</p>
        <ul>
          <li>jsonデータの編集に便利(例：オブジェクトの形を変更、データの追加・変更など)</li>
          <li>jsonデータをきれいに表示してくれる</li>
        </ul>  
        <p>2つ目の主張がピンとこない方は<a href="/os/linux-json-sample-messy.json">こちら</a>をみるとご理解いただけると思います。</p>
        <br>
        <p>進め方としては、次の動画を視聴した後に手元で動かしてみたいと思います。</p>
        <p>(足りない部分はChatGPTとかで補足かなぁ)</p>
        <ul>
            <li><a href="https://www.youtube.com/watch?v=m9dhrq9iRHA">The Ultimate JQ Tutorial: Everything You Need to Know to Parse JSON Like a Pro</a></li>
            <li><a href="https://www.youtube.com/watch?v=j7xZ2VkLYIY">jq: A Practical Guide</a></li>
        </ul>
        <p>jsonのサンプルとしては、<a href="/os/linux-jq-sample.json">こちら</a>を使おうと思います。ちなみに、1つのLinuxコマンドのためだけに2つ以上の教材を使ったのは自分なりのこだわりです。どんなすごい人でも教え方の癖や知識の偏りがあるはずなので、バランスの取れた見方ができるように色んなソースから情報を取るようにしています。</p>
        <br>

        <h2>2. jq基礎</h2>
        <h3>2-1. 基本の基本</h3>
        <p>まずは構文です。</p>
        <pre><code>jq filter input_file または cat/echo | jq filter</code></pre>
        <p>例: </p>
        <pre><code>cat linux-jq-sample.json |jq '.'</code></pre>
        <br>

        <h3>2-2. 深い階層のデータへのアクセス</h3>
        <p>DevOpsでの文脈だとオブジェクトに対してjqを使用することになると思うのでその前提で続けます。(<code>jq '.[]'</code>ではなく<code>jq '.'</code>となります)</p>
        <p>次のようにkeyを連結させるだけですね。ちなみに、下の例でいう.sukey.sub-subkeyはObject ID indexと呼ばれることもあるみたいです。</p>
        <pre><code>jq '.sukey.sub-subkey'</code></pre>
        <p>例:</p>
        <pre><code>$ cat ./os/linux-jq-sample.json |jq '.offices'
{
  "Tokyo": {
    "opened": 2016,
    "capacity": 120
  },
  "Osaka": {
    "opened": 2019,
    "capacity": 60
  }
}</code></pre>
        <br>

        <h3>2-3. -r オプション</h3>
        <p>文字列データを生出力したい時は<code>-r</code>オプションを使います。上記の動画内では""を取り除くというような言われ方をしていますが、手元で動かしてる感じjson形式ではなく生データとするといった方が正確な気がします。Manページでも次のように書いてますし。</p>
        <blockquote>--raw-output / -r: 
With this option, if the filter´s result is a string then it  willbe written directly to standard output rather than being formattedas  a  JSON  string  with quotes. This can be useful for making jqfilters talk to non-JSON-based systems.</blockquote>
        <br>
        <p>-rありの場合</p>
        <pre><code>$ cat ./linux-jq-sample.json |jq -r '.company.employees[].name'
Alice
Bob
Charlie
Diana</code></pre>
        <p>-rなしの場合</p>
        <pre><code>$ cat ./linux-jq-sample.json |jq '.company.employees[].name'
"Alice"
"Bob"
"Charlie"
"Diana"</code></pre>
        <br>
        <h3>2-4. Array/Object Constractor</h3>
        <h4>Array Constractor</h4>
        <p>jq '<code>[Object ID index]</code>'で出力結果をArrayに変換することができます。</p>
        <p>例を見てみましょう。</p>
        <p>例: Array Constractorなしの場合</p>
        <pre><code>$ cat linux-jq-sample.json |jq '.company.employees[].name'
"Alice"
"Bob"
"Charlie"
"Diana"</code></pre>
        <p>例: Array Constractorありの場合</p>
        <pre><code>$ cat linux-jq-sample.json |jq '[.company.employees[].name]'
[
  "Alice",
  "Bob",
  "Charlie",
  "Diana"
]</code></pre>
        <h4>Object Constractor</h4>
        <p>jq '<code>{"new_key", Object ID_index1}</code>'で出力結果をObjectに変換することができます。</p>
        <pre><code>$ cat inux-jq-sample.json |jq '{"employee_name":[.company.employees[].name]}'
{
  "employee_name": [
    "Alice",
    "Bob",
    "Charlie",
    "Diana"
  ]
}</code></pre>

        <h2>3. jq と | </h2>
        <p>jqコマンドはpipe (|)機能を用いて段階的にフィルターを適用することで上記より複雑な処理をすることができます。例えば、上記ではemployee_nameだけを取得していますが、employee_nameとemployee_ID, teamの組み合わせを取得することができるようになります。</p>
        <pre><code>$ cat ./os/linux-jq-sample.json |jq '{employee: [.company.employees[] | {id, name, team}]}'
{
  "employee": [
    {
      "id": 101,
      "name": "Alice",
      "team": "Platform"
    },
    {
      "id": 102,
      "name": "Bob",
      "team": "Frontend"
    },
    {
      "id": 103,
      "name": "Charlie",
      "team": "Platform"
    },
    {
      "id": 104,
      "name": "Diana",
      "team": "Platform"
    }
  ]
}</code></pre>
        <p>以下のように.[]を何度も書かないように気をつけてください。よくある間違いだそうです。自分もやりました。</p>
        <pre><code>jq '{"employee":{"employee_id": .company.employees[].id, "employee_name": .company.employees[].name, "team": .company.employees[].team}}'</code></pre>
        <p>何がだめかというとIDx名前xチームが全ての組み合わせになっています。例えば、欲しいのは101, Alice, Aliceの所属チーム1(Platform)などの組み合わせだけですが、他のメンバーの所属チームとの組み合わせまで作られてしまっています。</p>
        <p>Arrayの特定のkey-valueを組み合わせて新しい形のObjectを作る時は、'.example[] | new_key1: .element1, new_key2: .element2}’のように書きましょう。</p>
        <pre><code>{
  "employee": {
    "employee_id": 101,
    "employee_name": "Alice",
    "team": "Platform"
  }
}
{
  "employee": {
    "employee_id": 101,
    "employee_name": "Alice",
    "team": "Frontend"
  }
}
{
  "employee": {
    "employee_id": 101,
    "employee_name": "Alice",
    "team": "Platform"
  }
}</code></pre>
       <br>
       <h2>4. jq サブコマンド</h2>
       <h3>length</h3>
       <p>条件に合致するデータの数を数えるのに使えそうです。</p>
       <pre><code>$ cat sample.json|jq '.offices|length'
2</code></pre>
        <br>
       <h3>select</h3>
       <p>データの値に基づいてフィルタを設定するもの。絶対必要ですね。</p>
       <pre><code>$ cat sample.json|jq '[.projects[]|select(.budget > 100000)|{name: .name, budget: .budget}]'
[
  {
    "name": "Orion",
    "budget": 1200000
  },
  {
    "name": "Apollo",
    "budget": 600000
  }
]</code></pre>
       <br>
       <p>他にも挙げたらきりがないくらいありますが、最後にもう1つだけ。</p>
       <h3>@csv</h3>
       <p>Arrayのみが対象ですがCSVファイルにエキスポートする際に使えるみたいですね</p>
       <pre><code>$ cat sample.json|jq '.projects[]|select(.budget > 100000)|[.name, .budget]|@csv' > sample.csv
$ cat sample.csv
"\"Orion\",1200000"
"\"Apollo\",600000"       </code></pre>
        <br>
       <h2>5. 少しハマった点</h2>
       <p>Object Constructorの位置は少しハマりました。特に|を使ってデータをフィルタする時は、Object作成に使用する各データの共通項までにして、その後に{}を使うイメージですね(ここは完全に自分用の備忘録w)</p>
       <p>例: filter|filter|{key1:.filter-a.filter-aa.data, key2:.filter-b.filter-bb.data}</p>
       <br>
       <h2>5. 感想</h2>
       <p>jqへの苦手意識は克服できました。今回、色々触ってみましたが実際に使う必要ができた時はChtGPTにコマンド作ってもらうのが早そうですね。ChatGPTを使いこなすのに必要な知識を整理できたので良い勉強でした。</p>
      
      </article>
    </main>

    <footer class="site-footer">
      <p>© 2026 takatora</p>
    </footer>
  </div>
</body>
</html>
